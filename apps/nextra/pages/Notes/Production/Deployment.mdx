# PRODUCTION DEPLOYMENT

## Introduction

This guide outlines the steps to secure and optimize your web application by configuring HTTPS via Cloudflare and preparing an Ubuntu server for production deployment.

## Prerequisites

- Cloudflare account with your domain configured.
- Ubuntu server with root or sudo access and a web server (Nginx or Apache) installed.

## Configure Cloudflare

### DNS > Records

- Add 'Proxy status'. Ensure your domain's Proxy status is set to 'Proxied' to take advantage of Cloudflare's security and performance features.

### Rules > Page Rules

- **SSL = Flexible**: This setting allows traffic between Cloudflare and your server to be encrypted even if your server does not have an SSL certificate configured.
- **Cache Level = Bypass**: Use this rule for dynamic content that should not be cached by Cloudflare.

> **Note**: Cloudflare's Flexible SSL mode encrypts traffic between the browser and Cloudflare, making it a suitable option for sites without an SSL certificate on their server. For more information on SSL modes, visit [Cloudflare's SSL mode documentation](https://developers.cloudflare.com/ssl/origin-configuration/ssl-modes/flexible/).

## Configure Ubuntu Server

### Prepare for HTTPS Traffic

*Before configuring iptables, make sure your server is prepared to handle HTTPS traffic by setting up an SSL certificate and configuring your web server accordingly. Make sure your web server is configured to use the SSL certificate.*

#### Redirect HTTP to HTTPS
To ensure all traffic uses HTTPS, redirect HTTP traffic to HTTPS, utilizing iptables for this purpose.

1. Redirect from port 80 to 443 (if using HTTPS throughout):
```bash
sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 443
```
This rule redirects all HTTP traffic to HTTPS, ensuring secure communication.

2. Display iptables rules:
```bash
sudo iptables -t nat -L
```
Verify that your redirection rule is correctly listed.

### Persist iptables Rules (if needed)

Iptables rules are not automatically saved across reboots. To make them persistent:

1. Install iptables-persistent:
```bash
sudo apt-get install iptables-persistent
```

2. Save the current iptables rules:
```bash
sudo netfilter-persistent save
```

3. Ensure the rules are automatically loaded on boot:
```bash
sudo netfilter-persistent reload
```

## Conclusion
By completing these steps, you have configured Cloudflare for enhanced security and performance, prepared your Ubuntu server for HTTPS traffic, and ensured HTTP traffic is correctly redirected to HTTPS. This setup is crucial for a secure and efficient production deployment.

