"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9481],{29481:function(t,n,o){o.r(n),o.d(n,{default:function(){return s}});var a=o(52322),l=o(10836),i=o(67645).Z,r=o(39684);function s(t){let{deviceDefinition:n}=t;return(0,a.jsx)(r.wR,{brokerUrl:"ws://bo-firmware.protofy.xyz/ws",children:(0,a.jsx)(l.Z,{children:(0,a.jsx)(i,{deviceDefinition:n})})})}},67645:function(__unused_webpack_module,__webpack_exports__,__webpack_require__){var port,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(52322),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2784),_device_esptool_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(3089),_device_esptool_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(58895),_sleep__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(5436),_const__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(71155),_manifest__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(36076),_oldThings_apiCaller__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(50093),_device__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(6954),_DeviceModal__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(6873),react_topics__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(64509),_tamagui_next_theme__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(16399),mqtt_react_hooks__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(39684),protolib__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(28554),process=__webpack_require__(34406);let MqttStatus=t=>{let{}=t,{connectionStatus:n}=(0,mqtt_react_hooks__WEBPACK_IMPORTED_MODULE_3__.Td)();return(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{console.log("STATUS -----> ",n)},[n]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.Fragment,{})};Object.keys(_device__WEBPACK_IMPORTED_MODULE_4__).forEach(t=>window[t]=_device__WEBPACK_IMPORTED_MODULE_4__[t]);let resetTransport=async t=>{await t.device.setSignals({dataTerminalReady:!1,requestToSend:!0}),await t.device.setSignals({dataTerminalReady:!1,requestToSend:!1})},callText=async(t,n,o,a)=>{var l={method:n,headers:{"Content-Type":"text/plain;charset=UTF-8"}};o&&(l.body=o);let i="?";-1!=t.indexOf("?")&&(i="&");var r=t+(a?i+"token="+a:"");return console.log("Deff URL: ",r),fetch(r,l).then(function(t){return 200==t.status?"ok":(console.log(t.status),t.ok,t)})},saveYaml=async t=>{console.log("Save Yaml"),console.log(await callText("http://bo-firmware.protofy.xyz/api/v1/device/edit?configuration=test.yaml","POST",t))},DeviceScreen=param=>{let{deviceDefinition,isActive,topics}=param,topicData=topics,p={config:'[\n "mydevice",\n "esp32dev",\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  relay("light", "ALWAYS_OFF"),\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n  null,\n];\n\n'},[sourceCode,setSourceCode]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(p.config),[showModal,setShowModal]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(!1),[stage,setStage]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(""),[modalFeedback,setModalFeedback]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(),yamlRef=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(),connectSerialPort=async()=>{let t=!0;try{port=await navigator.serial.requestPort()}catch(n){return n.name,t}if(!port)return t;try{await port.open({baudRate:115200})}catch(n){return t}},flash=async t=>{let n,o;t({message:'Please hold "Boot" button of your ESP32 board.'});let a=new _device_esptool_js__WEBPACK_IMPORTED_MODULE_5__.J(port),l=new _device_esptool_js__WEBPACK_IMPORTED_MODULE_6__.p(a,115200,void 0);await port.close(),window.esploader=l;try{await l.main_fn()}catch(n){throw console.error(n),t({message:"Failed to initialize. Try resetting your device or holding the BOOT button while clicking INSTALL.",details:{error:_const__WEBPACK_IMPORTED_MODULE_7__.g.FAILED_INITIALIZING,details:n}}),await resetTransport(a),await a.disconnect(),"Failed to initialize. Try resetting your device or holding the BOOT button while clicking INSTALL."}if(console.log("chipFamily: ",o=l.chip.CHIP_NAME),!l.chip.ROM_TEXT)throw t({message:"Chip ".concat(o," is not supported"),details:{error:_const__WEBPACK_IMPORTED_MODULE_7__.g.NOT_SUPPORTED,details:"Chip ".concat(o," is not supported")}}),await resetTransport(a),await a.disconnect(),"Chip ".concat(o," is not supported");if(t({message:"Initialized. Found ".concat(o),details:{done:!0}}),!(n=_manifest__WEBPACK_IMPORTED_MODULE_8__.I.builds.find(t=>t.chipFamily===o)))throw t({message:"Your ".concat(o," board is not supported."),details:{error:_const__WEBPACK_IMPORTED_MODULE_7__.g.NOT_SUPPORTED,details:o}}),await resetTransport(a),await a.disconnect(),"Your ".concat(o," board is not supported.");t({message:"Preparing installation...",details:{done:!1}});let i=n.parts.map(async t=>{let n="http://bo-firmware.protofy.xyz/api/v1/device/download?configuration=test.yaml&type=firmware-factory.bin",o=await fetch(n);if(!o.ok)throw Error("Downlading firmware ".concat(n," failed: ").concat(o.status));let a=new FileReader,l=await o.blob();return new Promise(t=>{a.addEventListener("load",()=>t(a.result)),a.readAsBinaryString(l)})}),r=[],s=0;for(let o=0;o<i.length;o++)try{let t=await i[o];r.push({data:t,address:n.parts[o].offset}),s+=t.length}catch(n){t({message:n.message,details:{error:_const__WEBPACK_IMPORTED_MODULE_7__.g.FAILED_FIRMWARE_DOWNLOAD,details:n.message}}),await resetTransport(a),await a.disconnect();return}t({message:"Installation prepared",details:{done:!0}}),t({message:"Erasing device...",details:{done:!1}}),await l.erase_flash(),t({message:"Device erased",details:{done:!0}}),t({message:"Writing progress: 0%",details:{bytesTotal:s,bytesWritten:0,percentage:0}});let c=0;try{await l.write_flash(r,"keep","keep","keep",!1,!0,(n,o,a)=>{let l=o/a*r[n].data.length,i=Math.floor((c+l)/s*100);if(o===a){c+=l;return}t({message:"Writing progress: ".concat(i,"%"),details:{bytesTotal:s,bytesWritten:c+o,percentage:i}})})}catch(n){t({message:n.message,details:{error:_const__WEBPACK_IMPORTED_MODULE_7__.g.WRITE_FAILED,details:n}}),await resetTransport(a),await a.disconnect();return}t({message:"Writing complete",details:{bytesTotal:s,bytesWritten:c,percentage:100}}),await (0,_sleep__WEBPACK_IMPORTED_MODULE_9__._)(100),console.log("HARD RESET"),await resetTransport(a),console.log("DISCONNECT"),await a.disconnect(),t({message:"All done!"})},sendMessage=async t=>{await fetch("http://bo-firmware.protofy.xyz/api/v1/device/compile")},{message}=(0,mqtt_react_hooks__WEBPACK_IMPORTED_MODULE_3__.mU)(["device/compile"]),compile=async()=>{setModalFeedback({message:"Compiling firmware...",details:{error:!1}});let t={type:"spawn",configuration:"test.yaml"};sendMessage(JSON.stringify(t))};react__WEBPACK_IMPORTED_MODULE_1__.useEffect(()=>{console.log("Compile Message: ",message);try{if(null==message?void 0:message.message){let t=JSON.parse(null==message?void 0:message.message.toString());"exit"==t.event&&0==t.code?(console.log("Succesfully compiled"),setStage("upload")):"exit"==t.event&&0!=t.code&&(console.error("Error compiling"),setModalFeedback({message:"Error compiling code. Please check your flow configuration.",details:{error:!0}}))}}catch(t){console.log(t)}},[message]);let flashCb=t=>{console.log(t),setModalFeedback(n=>n=t)},checkWifiPowerMode=(t,n)=>{let o=t.split("\n");console.log("newWifiPowerMode",n),o[5]='  "'.concat(n,'",');let a=o.join("\n");return a},onSave=async code=>{let apiCaller=new _oldThings_apiCaller__WEBPACK_IMPORTED_MODULE_10__.Z;try{let deviceCode="device("+code.slice(0,-2)+")",deviceObj=eval(deviceCode),yaml=deviceObj.setMqttPrefix(process.env.NEXT_PUBLIC_PROJECT_NAME).create(deviceDefinition),modifiedCode=checkWifiPowerMode(code,deviceObj.wifiPowerMode);console.log("modifiedCode",modifiedCode,code),yamlRef.current=yaml,console.log("yaml generated: ",yaml)}catch(e){console.error(e)}},onPlay=code=>{console.log("\uD83D\uDE80 ~ file: DeviceEditor.tsx:409 ~ onPlay ~ code:",code);let deviceCode="device("+code+")",deviceObj=eval(deviceCode),yaml=deviceObj.create(deviceDefinition[0]);yamlRef.current=yaml,setShowModal(!0);try{setStage("yaml")}catch(e){console.error("error writting firmware: ",e)}},onSelectPort=async()=>{let t=await connectSerialPort();t||setStage("write")};(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>{let t=async()=>{if("yaml"==stage)await saveYaml(yamlRef.current),setStage("compile");else if("compile"==stage)console.log("stage - compile"),await compile();else if("write"==stage)try{await flash(flashCb),setStage("idle")}catch(t){flashCb({message:"Error writing the device. Check that the USB connection and serial port are correctly configured.",details:{error:!0}})}else if("upload"==stage){let t=navigator.userAgent.includes("Chrome")||navigator.userAgent.includes("Edge")||navigator.userAgent.includes("Opera");t?(setModalFeedback({message:"Connect your device and click select to chose the port. ",details:{error:!1}}),console.log("chormium based true")):(console.log("chormium based very false"),setModalFeedback({message:"You need Chrome, Opera or Edge to upload the code to the device.",details:{error:!0}}))}};t()},[stage]);let{resolvedTheme}=(0,_tamagui_next_theme__WEBPACK_IMPORTED_MODULE_11__.P)();return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("div",{style:{width:"100%",display:"flex",flex:1},children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(MqttStatus,{}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(_DeviceModal__WEBPACK_IMPORTED_MODULE_12__.Z,{stage:stage,onCancel:()=>setShowModal(!1),onSelect:onSelectPort,modalFeedback:modalFeedback,showModal:showModal}),sourceCode?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(protolib__WEBPACK_IMPORTED_MODULE_13__.Z,{onPlay:onPlay,onSave:t=>{console.log("ON SAVE: ",t),console.log("sourceCode ",sourceCode)},hideBaseComponents:!0,disableStart:!0,getFirstNode:t=>t.find(t=>"ArrayLiteralExpression"==t.type),showActionsBar:!0,mode:"device",bridgeNode:!1,sourceCode:sourceCode,themeMode:resolvedTheme}):null]})};__webpack_exports__.Z=(0,react_topics__WEBPACK_IMPORTED_MODULE_2__.Ic)(DeviceScreen,{topics:["device/changedDeviceName"]})},50093:function(t,n,o){o.d(n,{Z:function(){return c}});let a=()=>({apiUrl:"http://localhost",imagesUrl:"test"}),{apiUrl:l,imagesUrl:i}=a();var r={getApiURL:()=>l,getMqttURL:()=>{var t="ws";l.startsWith("https")&&(t+="s");let n=l.split(":");n.shift();let o=n.join().split("/");return o[o.length-1]="ws",t+":"+o.join("/")},getImagesURL:()=>i};class s{async call(t,n,o,a){var l={method:n,headers:{"Content-Type":"application/json"}};o&&(l.body=JSON.stringify(o));let i="?";-1!=t.indexOf("?")&&(i="&");var s=t+(this.token?i+"token="+this.token:""),c=a||r.getApiURL();return fetch(c+s,l).then(function(t){if(!t.ok){let n={statusCode:t.status,status:"rejected",statusText:t.statusText,url:t.url};throw Error(JSON.stringify(n))}return t}).then(t=>t.json())}async uploadFile(t,n){return fetch(t,{method:"post",body:n})}constructor(t,n){this.token=t||"",this.apiUrl=n||r.getApiURL()}}var c=s}}]);