name: Protofy CI Docker tests
on:
  workflow_dispatch:  # Allows manual triggering

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Healthcheck versions
      run: |
        docker -v
        docker compose version
        docker-compose -v
        id
        groups
    - name: Prepare Docker Volumes 
      run: |
        cd docker 
        ./init
    - name: Build Image
      run: |
        cd docker 
        ./build
    - name: Start Docker project in Development and background
      run: |
        cd docker 
        source ./helpers/get-envs
        $DOCKER_COMPOSE_CMD -p protofy $SERVICES_COMPOSE_FILES up -d
    - name: Services logs
      if: false # skip by deault enable for debugging purposes
      run: |
        cd docker
        ./logs
    - name: Healthcheck docker services start
      run: node .github/scripts/healthcheck-start.js